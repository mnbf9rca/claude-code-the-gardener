{% extends "base.html" %}

{% block title %}Conversations - Claude the Gardener{% endblock %}

{% block content %}
<div class="conversations-page">
    <header class="page-header">
        <h1>= Conversation History</h1>
        <p class="subtitle">{{ conversations|length }} conversations with Claude the Gardener</p>
    </header>

    <div class="filter-controls">
        <input type="text" id="search-conversations" placeholder="Search conversations..." class="search-input">
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="highlights">Highlights</button>
        </div>
        <div class="filter-section">
            <label>Filter by Tools (click multiple for AND):</label>
            <div class="tool-filter-buttons">
                {% for tool_name, count in all_tools %}
                <button class="tool-filter-btn" data-tool="{{ tool_name }}" title="{{ count }} uses">
                    {{ tool_icons.get(tool_name, 'ðŸ”§') }} {{ tool_name.replace('_', ' ').title() }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    {% include 'includes/date-filter.html' %}

    <div class="conversation-grid">
        {% for conv in conversations %}
        <div class="conversation-card"
             data-tools="{% for tool in conv.tool_calls %}{{ tool.name.replace('mcp__plant-tools__', '').replace('mcp__', '') }}{% if not loop.last %},{% endif %}{% endfor %}"
             data-highlight="{{ 'yes' if conv in highlights else 'no' }}"
             data-timestamp="{{ conv.start_time }}">
            <div class="card-header">
                <div class="card-title">
                    <a href="{{ conv.session_id }}.html">Session {{ conv.session_id }}</a>
                </div>
                <div class="card-meta">
                    {{ conv.start_time[:10] }} {{ conv.start_time[11:16] }} " {{ conv.duration_human }}
                </div>
            </div>

            <div class="card-stats">
                <div class="stat-item">
                    <span class="stat-icon">='</span>
                    <span class="stat-text">{{ conv.tool_call_count }} tools</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">=</span>
                    <span class="stat-text">{{ conv.message_count }} messages</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">=</span>
                    <span class="stat-text">{{ (conv.tokens.input + conv.tokens.output + conv.tokens.cache_read + conv.tokens.cache_creation) | format_number }} tokens</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">=</span>
                    <span class="stat-text">${{ "%.3f"|format(conv.cost_usd) }}</span>
                </div>
            </div>

            {% if conv.tool_counts %}
            <div class="tool-badges">
                {% for tool_name, count in conv.tool_counts.items() %}
                <span class="tool-badge" data-tool="{{ tool_name }}" title="{{ tool_name }}">
                    {{ tool_icons.get(tool_name, 'ðŸ”§') }}{{ count }}
                </span>
                {% endfor %}
            </div>
            {% endif %}

            {% if conv.last_assistant_message_html %}
            <div class="card-snippet">
                {{ conv.last_assistant_message_html | safe }}
            </div>
            {% endif %}

            {% if conv in highlights %}
            <div class="highlight-badges">
                {% for reason in conv.highlight_reasons %}
                <span class="badge">{{ reason }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="../static/js/time-utils.js"></script>
<script src="../static/js/date-filter.js"></script>
<script>
// Store active filters
let activeTypeFilter = 'all';
let activeToolFilters = new Set(); // Multi-select for tools
let activeSearchTerm = '';
let activeDateRange = { from: null, to: null };

function applyAllFilters() {
    const cards = document.querySelectorAll('.conversation-card');

    cards.forEach(card => {
        const cardText = card.textContent.toLowerCase();
        const cardTimestamp = new Date(card.dataset.timestamp).getTime();

        // Type filter
        let matchesType = false;
        if (activeTypeFilter === 'all') {
            matchesType = true;
        } else if (activeTypeFilter === 'highlights') {
            matchesType = card.dataset.highlight === 'yes';
        }

        // Tool filter (AND logic - must have ALL selected tools)
        let matchesTool = true;
        if (activeToolFilters.size > 0) {
            const cardTools = card.dataset.tools.split(',');
            // Check if card has ALL selected tools
            for (let tool of activeToolFilters) {
                if (!cardTools.includes(tool)) {
                    matchesTool = false;
                    break;
                }
            }
        }

        // Search filter
        const matchesSearch = !activeSearchTerm || cardText.includes(activeSearchTerm);

        // Date range filter
        let matchesDateRange = true;
        if (activeDateRange.from !== null || activeDateRange.to !== null) {
            const fromTime = activeDateRange.from || 0;
            const toTime = activeDateRange.to || Date.now() + 86400000;
            matchesDateRange = cardTimestamp >= fromTime && cardTimestamp <= toTime;
        }

        // Show only if all filters match
        card.style.display = (matchesType && matchesTool && matchesSearch && matchesDateRange) ? 'block' : 'none';
    });

    // Update button count display
    const filterCount = activeToolFilters.size;
    document.querySelectorAll('.tool-filter-btn').forEach(btn => {
        if (activeToolFilters.has(btn.dataset.tool)) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

document.getElementById('search-conversations').addEventListener('input', function(e) {
    activeSearchTerm = e.target.value.toLowerCase();
    applyAllFilters();
});

document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        activeTypeFilter = this.dataset.filter;
        applyAllFilters();
    });
});

// Tool filter buttons (multi-select toggle)
document.querySelectorAll('.tool-filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tool = this.dataset.tool;

        // Toggle tool in set
        if (activeToolFilters.has(tool)) {
            activeToolFilters.delete(tool);
        } else {
            activeToolFilters.add(tool);
        }

        applyAllFilters();
    });
});

// Initialize date range filter
initDateFilter((fromTime, toTime) => {
    activeDateRange = { from: fromTime, to: toTime };
    applyAllFilters();
});
</script>
{% endblock %}
