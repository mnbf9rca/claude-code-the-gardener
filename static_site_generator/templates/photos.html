{% extends "base.html" %}

{% block title %}Photo Gallery - Claude the Gardener{% endblock %}

{% block content %}
<div class="photos-page">
    <header class="page-header">
        <h1> Photo Gallery</h1>
        <p class="subtitle">{{ photos|length }} photos of the plant's journey</p>
    </header>

    {% include 'includes/date-filter.html' %}

    <div class="photos-grid">
        {% for photo in photos %}
        {% if photo.photo_path %}
        <div class="photo-card{% if not photo.photo_exists %} missing-photo{% endif %}" data-timestamp="{{ photo.timestamp }}">
            <div class="photo-wrapper">
                {% if photo.photo_exists %}
                <img src="../photos/{{ photo.photo_path.split('/')[-1] }}"
                     alt="Plant photo from {{ photo.timestamp }}"
                     loading="lazy"
                     class="photo-img">
                {% else %}
                <div class="missing-photo-placeholder">
                    <span class="missing-icon">üì∑</span>
                    <p class="missing-text">Photo Missing</p>
                    <p class="missing-filename">{{ photo.photo_path.split('/')[-1] }}</p>
                </div>
                {% endif %}
            </div>
            <div class="photo-meta">
                <div class="photo-time">{{ photo.timestamp }}</div>
                {% if not photo.photo_exists %}
                <div class="photo-missing-badge">‚ö†Ô∏è File not found</div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="../static/js/time-utils.js"></script>
<script src="../static/js/date-filter.js"></script>
<script>
let activeDateRange = { from: null, to: null };

function applyDateFilter() {
    const photos = document.querySelectorAll('.photo-card');

    photos.forEach(photo => {
        const photoTimestamp = new Date(photo.dataset.timestamp).getTime();

        // Date range filter
        let matchesDateRange = true;
        if (activeDateRange.from !== null || activeDateRange.to !== null) {
            const fromTime = activeDateRange.from || 0;
            const toTime = activeDateRange.to || Date.now() + 86400000;
            matchesDateRange = photoTimestamp >= fromTime && photoTimestamp <= toTime;
        }

        photo.style.display = matchesDateRange ? 'block' : 'none';
    });
}

// Initialize date range filter
initDateFilter((fromTime, toTime) => {
    activeDateRange = { from: fromTime, to: toTime };
    applyDateFilter();
});
</script>
{% endblock %}
