#!/bin/bash
# sync-to-r2.sh — Sync Pi data to Cloudflare R2 and workspace to GitHub
# Run as gardener-publisher via gardener-sync.timer every 15 minutes

set -euo pipefail

log() { echo "[$(date -Iseconds)] $*"; }

REMOTE="r2-gardener"
BUCKET_DATA="gardener-data"    # private: sessions, sensor data, notes
BUCKET_PHOTOS="gardener-photos" # public: photos only (custom domain)
# Reuses the existing gardener-site repo clone (already has SSH deploy key configured)
WORKSPACE_STAGING="/home/gardener-publisher/gardener-site"

# State file — touched after each successful sync run.
# find -newer uses its mtime so only files created/modified since the last
# successful sync are processed. R2 is append-only: deletes on Pi never
# propagate to R2.
#
# IMPORTANT: touch this file after the initial bulk sync completes so the
# 15-min timer only handles incremental new files going forward:
#   sudo touch /home/gardener-publisher/.sync-state
STATE_FILE="/home/gardener-publisher/.sync-state"

# sync_with_dates BUCKET SRC R2_DEST_PREFIX
#
# Copies files from SRC that are newer than STATE_FILE to R2, organised by
# file mtime: BUCKET/R2_DEST_PREFIX/YYYY/MM/DD/rel_path
# Skips entirely if STATE_FILE does not exist (guards against slow first run
# before the initial bulk sync has completed).
# Logs one line per copied file; periodic heartbeat every 100 files examined.
sync_with_dates() {
    local bucket="$1"
    local src="$2"
    local r2_dest="$3"

    if [ ! -f "$STATE_FILE" ]; then
        log "  Skipping ${r2_dest}: no state file at ${STATE_FILE}."
        log "  Touch it after the initial bulk sync to enable incremental mode."
        return
    fi

    local count=0
    while IFS= read -r file; do
        local mtime date_path rel_path dest_path
        mtime=$(stat -c '%Y' "$file")
        date_path=$(date -d "@${mtime}" +%Y/%m/%d)
        rel_path=$(realpath --relative-to="$src" "$file")
        if [ -n "$r2_dest" ]; then
            dest_path="${bucket}/${r2_dest}/${date_path}/${rel_path}"
        else
            dest_path="${bucket}/${date_path}/${rel_path}"
        fi
        # --log-level INFO shows "filename: Copied (new)" for actual copies, silent for skips.
        # --stats-log-level DEBUG hides the per-transfer stats blocks (Transferred/Checks/Elapsed)
        # which rclone emits at NOTICE by default and which add noise without useful information.
        rclone copyto \
            "$file" \
            "${REMOTE}:${dest_path}" \
            --log-level INFO \
            --stats-log-level DEBUG
        count=$((count + 1))
        if (( count % 100 == 0 )); then
            log "  ... ${count} examined so far"
        fi
    done < <(find "$src" -type f -newer "$STATE_FILE" -not -path '*/.git/*')
    log "  ${count} examined → ${bucket}/${r2_dest}"
}

log "=== Gardener Sync Start ==="

# 1. Sensor JSONL + notes.md
#    rclone copy never deletes; exclude ephemeral light_state.json and notes_archive/ subdir
#    (notes_archive/ is synced separately to raw/notes/ below)
log "Syncing sensor data..."
rclone copy \
    /home/mcpserver/data/ \
    "${REMOTE}:${BUCKET_DATA}/raw/data/" \
    --exclude="light_state.json" \
    --exclude="notes_archive/**" \
    --exclude=".git/**" \
    --log-level NOTICE

# 2. Photos — public bucket, organised by file mtime into YYYY/MM/DD/
log "Syncing photos..."
sync_with_dates \
    "${BUCKET_PHOTOS}" \
    /home/mcpserver/photos/ \
    ""

# 3. Claude session JSONL — private bucket, organised by file mtime into raw/sessions/YYYY/MM/DD/
log "Syncing sessions..."
sync_with_dates \
    "${BUCKET_DATA}" \
    /home/gardener/.claude/projects/-home-gardener-workspace/ \
    "raw/sessions"

# 4. Notes archive — auto-generated by MCP when agent updates notes.md
log "Syncing notes archive..."
rclone copy \
    /home/mcpserver/data/notes_archive/ \
    "${REMOTE}:${BUCKET_DATA}/raw/notes/" \
    --exclude=".git/**" \
    --log-level NOTICE

# 5. Workspace → GitHub
#    rsync into the local git clone (--delete keeps it current-state-only)
#    then commit and push if anything changed
log "Syncing workspace to GitHub..."
rsync_rc=0
rsync -a --delete \
    --exclude=".git/" \
    /home/gardener/workspace/ \
    "${WORKSPACE_STAGING}/" || rsync_rc=$?
# Exit 23 = partial transfer (some files unreadable — fix with: sudo chmod -R o+r /home/gardener/workspace/)
# Treat as non-fatal so the state file still gets touched and git push still runs.
if [ "$rsync_rc" -ne 0 ] && [ "$rsync_rc" -ne 23 ]; then
    log "ERROR: rsync failed with exit code ${rsync_rc}"
    exit "$rsync_rc"
elif [ "$rsync_rc" -eq 23 ]; then
    log "WARNING: rsync exit 23 — some workspace files were unreadable (permission denied)"
fi

cd "${WORKSPACE_STAGING}"
git add -A
if ! git diff --staged --quiet; then
    git commit -m "Workspace snapshot $(date -Iseconds)"
    git push origin main
    log "Workspace pushed to GitHub"
else
    log "No workspace changes to push"
fi

# Update state file — marks the high-water point for the next incremental sync.
# Only reached if all sections above completed without error (set -e).
touch "$STATE_FILE"

log "=== Sync complete ==="
