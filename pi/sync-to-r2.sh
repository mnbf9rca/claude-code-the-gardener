#!/bin/bash
# sync-to-r2.sh — Sync Pi data to Cloudflare R2 and workspace to GitHub
# Run as gardener-publisher via gardener-sync.timer every 15 minutes

set -euo pipefail

log() { echo "[$(date -Iseconds)] $*"; }

REMOTE="r2-gardener"
BUCKET="gardener-data"
# Reuses the existing gardener-site repo clone (already has SSH deploy key configured)
WORKSPACE_STAGING="/home/gardener-publisher/gardener-site"

# sync_with_dates SRC R2_DEST_PREFIX [extra rclone args...]
#
# Copies files from SRC to R2 organised by file mtime: R2_DEST_PREFIX/YYYY/MM/DD/rel_path
# Uses rclone copyto per file so the destination path can be constructed from mtime.
# rclone copyto is idempotent: skips files already in R2 with matching size/mtime.
sync_with_dates() {
    local src="$1"
    local r2_dest="$2"
    shift 2
    local -a rclone_args=("$@")

    local count=0
    while IFS= read -r file; do
        local mtime date_path rel_path
        mtime=$(stat -c '%Y' "$file")
        date_path=$(date -d "@${mtime}" +%Y/%m/%d)
        rel_path=$(realpath --relative-to="$src" "$file")
        rclone copyto \
            "$file" \
            "${REMOTE}:${BUCKET}/${r2_dest}/${date_path}/${rel_path}" \
            "${rclone_args[@]}"
        count=$((count + 1))
    done < <(find "$src" -type f)
    log "  ${count} file(s) checked/synced → ${r2_dest}"
}

log "=== Gardener Sync Start ==="

# 1. Sensor JSONL + notes.md
#    rclone copy never deletes; exclude ephemeral light_state.json and notes_archive/ subdir
#    (notes_archive/ is synced separately to raw/notes/ below)
log "Syncing sensor data..."
rclone copy \
    /home/mcpserver/data/ \
    "${REMOTE}:${BUCKET}/raw/data/" \
    --exclude="light_state.json" \
    --exclude="notes_archive/**" \
    --exclude=".git/**" \
    --log-level INFO

# 2. Photos — organised by file mtime into raw/photos/YYYY/MM/DD/
log "Syncing photos..."
sync_with_dates \
    /home/mcpserver/photos/ \
    "raw/photos" \
    --log-level INFO

# 3. Claude session JSONL — organised by file mtime into raw/sessions/YYYY/MM/DD/
log "Syncing sessions..."
sync_with_dates \
    /home/gardener/.claude/projects/-home-gardener-workspace/ \
    "raw/sessions" \
    --log-level INFO

# 4. Notes archive — auto-generated by MCP when agent updates notes.md
log "Syncing notes archive..."
rclone copy \
    /home/mcpserver/data/notes_archive/ \
    "${REMOTE}:${BUCKET}/raw/notes/" \
    --log-level INFO

# 5. Workspace → GitHub
#    rsync into the local git clone (--delete keeps it current-state-only)
#    then commit and push if anything changed
log "Syncing workspace to GitHub..."
rsync -a --delete \
    --exclude=".git/" \
    /home/gardener/workspace/ \
    "${WORKSPACE_STAGING}/"

cd "${WORKSPACE_STAGING}"
git add -A
if ! git diff --staged --quiet; then
    git commit -m "Workspace snapshot $(date -Iseconds)"
    git push origin main
    log "Workspace pushed to GitHub"
else
    log "No workspace changes to push"
fi

log "=== Sync complete ==="
