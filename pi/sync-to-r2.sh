#!/bin/bash
# sync-to-r2.sh — Sync Pi data to Cloudflare R2 and workspace to GitHub
# Run as gardener-publisher via gardener-sync.timer every 15 minutes

set -euo pipefail

log() { echo "[$(date -Iseconds)] $*"; }

REMOTE="r2-gardener"
BUCKET="gardener-data"
# Reuses the existing gardener-site repo clone (already has SSH deploy key configured)
WORKSPACE_STAGING="/home/gardener-publisher/gardener-site"

log "=== Gardener Sync Start ==="

# 1. Sensor JSONL + notes.md
#    rclone copy never deletes; exclude ephemeral light_state.json and notes_archive/ subdir
#    (notes_archive/ is synced separately to raw/notes/ below)
log "Syncing sensor data..."
rclone copy \
    /home/mcpserver/data/ \
    "${REMOTE}:${BUCKET}/raw/data/" \
    --exclude="light_state.json" \
    --exclude="notes_archive/**" \
    --exclude=".git/**" \
    --log-level INFO

# 2. Photos — immutable timestamped filenames; rclone copy never deletes
log "Syncing photos..."
rclone copy \
    /home/mcpserver/photos/ \
    "${REMOTE}:${BUCKET}/raw/photos/" \
    --log-level INFO

# 3. Claude session JSONL — one file per 15-min agent run; accumulate forever
#    Use NOTICE level + per-minute stats to avoid per-file noise (~16k files on first run)
log "Syncing sessions..."
rclone copy \
    /home/gardener/.claude/projects/-home-gardener-workspace/ \
    "${REMOTE}:${BUCKET}/raw/sessions/" \
    --log-level NOTICE \
    --stats 1m --stats-one-line

# 4. Notes archive — auto-generated by MCP when agent updates notes.md
log "Syncing notes archive..."
rclone copy \
    /home/mcpserver/data/notes_archive/ \
    "${REMOTE}:${BUCKET}/raw/notes/" \
    --log-level INFO

# 5. Workspace → GitHub
#    rsync into the local git clone (--delete keeps it current-state-only)
#    then commit and push if anything changed
log "Syncing workspace to GitHub..."
rsync -a --delete \
    --exclude=".git/" \
    /home/gardener/workspace/ \
    "${WORKSPACE_STAGING}/"

cd "${WORKSPACE_STAGING}"
git add -A
if ! git diff --staged --quiet; then
    git commit -m "Workspace snapshot $(date -Iseconds)"
    git push origin main
    log "Workspace pushed to GitHub"
else
    log "No workspace changes to push"
fi

log "=== Sync complete ==="
